<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Ruleta de Historias (DEBUG)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body style="background:#ffffff; color:#000; font-family:sans-serif;">

  <h1>Ruleta de historias (modo debug)</h1>
  <p>Si ves este texto, el HTML se ha cargado correctamente.</p>

  <p><strong>Estado:</strong> <span id="status">Cargando historias...</span></p>

  <div id="preview" style="border:1px solid #ccc; padding:10px; margin:10px 0;">
    <p><strong>Historia en bombo:</strong> <span id="preview-title">‚Äì</span></p>
    <img id="preview-image" src="" alt="Imagen de historia" style="max-width:100%; height:auto; background:#eee;">
  </div>

  <button id="toggle-button" disabled>‚è≥ Cargando‚Ä¶</button>

  <div id="selected" style="margin-top:20px; padding:10px; border:1px solid #ccc; display:none;">
    <h2 id="selected-title"></h2>
    <p id="selected-synopsis"></p>
    <p><a id="selected-link" href="#" target="_blank">üìñ Leer historia</a></p>
  </div>

  <script>
    // Rutas para GitHub Pages (y tambi√©n valen en local si sirves con http)
    const STORIES_URL = "admin/metadata.json";
    const IMAGE_BASE_PATH = "imagenes/";
    const STORY_URL_BASE = "https://www.disturbingstories.com/";

    let stories = [];
    let spinning = false;
    let intervalId = null;
    let currentIndex = -1;

    const statusEl = document.getElementById("status");
    const previewTitleEl = document.getElementById("preview-title");
    const previewImgEl = document.getElementById("preview-image");
    const btnEl = document.getElementById("toggle-button");
    const selectedBoxEl = document.getElementById("selected");
    const selectedTitleEl = document.getElementById("selected-title");
    const selectedSynopsisEl = document.getElementById("selected-synopsis");
    const selectedLinkEl = document.getElementById("selected-link");

    async function loadStories() {
      try {
        statusEl.textContent = "Haciendo fetch a " + STORIES_URL + "...";

        const res = await fetch(STORIES_URL);
        if (!res.ok) {
          throw new Error("Respuesta HTTP no OK: " + res.status + " " + res.statusText);
        }

        const data = await res.json();
        console.log("JSON cargado:", data);

        stories = Object.entries(data).map(([id, item]) => ({
          id,
          title: item.titulo,
          synopsis: item.sinopsis,
          image: IMAGE_BASE_PATH + id + ".jpg",
          url: STORY_URL_BASE + id + ".html"
        }));

        if (stories.length === 0) {
          throw new Error("metadata.json est√° vac√≠o o sin historias.");
        }

        currentIndex = 0;
        updatePreview(stories[currentIndex]);

        statusEl.textContent = "Historias cargadas: " + stories.length;
        btnEl.disabled = false;
        btnEl.textContent = "üé≤ Empezar";

      } catch (e) {
        console.error("Error cargando historias:", e);
        statusEl.textContent = "ERROR al cargar historias: " + e.message;
        btnEl.disabled = true;
      }
    }

    function updatePreview(story) {
      previewTitleEl.textContent = story.title + " (ID: " + story.id + ")";
      previewImgEl.src = story.image;
    }

    function getRandomIndex() {
      let idx;
      if (stories.length === 1) return 0;
      do {
        idx = Math.floor(Math.random() * stories.length);
      } while (idx === currentIndex);
      currentIndex = idx;
      return idx;
    }

    function startSpinning() {
      spinning = true;
      selectedBoxEl.style.display = "none";
      btnEl.textContent = "‚úã Detener";

      intervalId = setInterval(() => {
        const idx = getRandomIndex();
        updatePreview(stories[idx]);
      }, 80);
    }

    function stopSpinning() {
      spinning = false;
      clearInterval(intervalId);

      const story = stories[currentIndex];
      updatePreview(story);

      selectedTitleEl.textContent = story.title + " (ID: " + story.id + ")";
      selectedSynopsisEl.textContent = story.synopsis;
      selectedLinkEl.href = story.url;
      selectedBoxEl.style.display = "block";

      btnEl.textContent = "üé≤ Volver a girar";
    }

    btnEl.addEventListener("click", () => {
      if (!spinning) startSpinning();
      else stopSpinning();
    });

    loadStories();
  </script>
</body>
</html>
